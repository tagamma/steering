#!/usr/bin/env bash
# Shared pre-commit hook for steering
# Automatically calls the steering tool to regenerate AI configurations.
#
# This script is intended to be copied to .git/hooks/pre-commit in repositories
# that use the steering system.

set -e

# --- Configuration ---
# You can override these by setting environment variables or modifying this section.

# The URI of the steering flake.
# We use the one from tagamma/nix-config.
# Using git+ssh to ensure we use SSH keys for authentication if the repo is private.
# Added shallow=1 to avoid downloading the entire git history
STEERING_FLAKE_URI="${STEERING_FLAKE_URI:-git+ssh://git@github.com/tagamma/nix-config?dir=projects/steering&shallow=1}"

# Path to the steering configuration file.
STEERING_CONFIG="${STEERING_CONFIG:-steering.yaml}"

# --- End Configuration ---

# Check if the config file exists
if [ ! -f "$STEERING_CONFIG" ]; then
    # If no config file, silent exit (maybe not configured for this repo)
    # Or maybe we should warn? For now, let's just check if relevant files changed first.
    exit 0
fi

# Check if any relevant files are staged
# We look for changes in AGENTS files or the directories defined in the config (heuristic)
# A simple heuristic is: AGENTS files or *.mdc files
relevant_files=$(git diff --cached --name-only | grep -E 'AGENTS\.(md|mdc)$|\.mdc$' || true)

if [ -z "$relevant_files" ]; then
    # No relevant files changed
    exit 0
fi

echo "Detected changes to AI rules or AGENTS files."
echo "$relevant_files" | sed 's/^/  - /'
echo ""
echo "Regenerating AI configurations with steering..."

# Run steering
# We use `nix run` to execute steering from the remote flake.
if ! nix run "$STEERING_FLAKE_URI" -- generate --input . --output . --config-path "$STEERING_CONFIG"; then
    echo ""
    echo "Failed to regenerate AI configurations."
    echo "Please fix the errors above and try committing again."
    exit 1
fi

# Check for generated files and stage them
# This list should match what steering generates
generated_files=$(git status --porcelain | grep -E '^\s*[AM]\s+(.cursor/rules/|CLAUDE\.md|GEMINI\.md)' || true)

if [ -n "$generated_files" ]; then
    echo ""
    echo "Generated AI configurations updated:"
    echo "$generated_files" | sed 's/^/  /'
    echo ""
    echo "Staging generated files..."

    # Stage generated files
    # We try to be specific to avoid adding unwanted files
    
    # .cursor/rules
    if [ -d ".cursor/rules" ]; then
        git add .cursor/rules/*.mdc 2>/dev/null || true
    fi
    
    # CLAUDE.md
    if [ -f "CLAUDE.md" ]; then
        git add CLAUDE.md
    fi

    # GEMINI.md
    if [ -f "GEMINI.md" ]; then
        git add GEMINI.md
    fi

    echo "Generated files staged."
fi

exit 0